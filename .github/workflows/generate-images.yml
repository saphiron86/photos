name: Generate images.json

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug â€“ list images folder
        run: |
          echo "Listing images folder:" 
          ls -la
          ls -la images || echo "images folder missing"

      - name: Generate images.json (pure bash, no jq)
        run: |
          mkdir -p images
          echo '[' > images/images.json
          first=true
          for f in images/*.{png,jpg,jpeg,webp,gif}; do
            [ -e "$f" ] || continue
            name=$(basename "$f")
            if [ "$first" = true ]; then
              first=false
            else
              echo ',' >> images/images.json
            fi
            echo "  \"$name\"" >> images/images.json
          done
          echo ']' >> images/images.json

          echo "Generated images.json:" 
          cat images/images.json

      - name: Commit images.json
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add images/images.json
          git commit -m "Auto-generate images.json" || echo "No changes to commit"
          git push
